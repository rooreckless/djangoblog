# CodeBuildãŒä½¿ã†ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã™ã‚‹å†…å®¹
version: 0.2

phases:
  install:
    # runtime-versions:
    #   docker: 20
    commands:
      - echo "[Install] Installing dependencies"
      - apt-get update
      - apt-get install -y jq git
      - which git
      - which jq
      - jq --version
  pre_build:
    commands:
      - echo "[PreBuild] Logging into Docker Hub"
      - export DOCKER_USERNAME=$(aws ssm get-parameter --name dockerhub_username --query "Parameter.Value" --output text)
      - export DOCKER_PASSWORD=$(aws ssm get-parameter --name dockerhub_password --with-decryption --query "Parameter.Value" --output text)
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - echo "[PreBuild] Checking environment"
      - echo $CODEBUILD_SRC_DIR
      - echo "[PreBuild] Fetching env files from Parameter Store"
      # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      - mkdir -p .envs/development
      # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯paramterstoreã‹ã‚‰get-paramterã‚’--with-decryptionã¤ãã§å®Ÿæ–½ -> ãƒ•ã‚¡ã‚¤ãƒ«ã¸å‡ºåŠ›
      - aws ssm get-parameter --name djangoblog_envs_development_frontend --with-decryption --query "Parameter.Value" --output text > .envs/development/frontend

      - aws ssm get-parameter --name djangoblog_envs_development_django --with-decryption --query "Parameter.Value" --output text > .envs/development/django

      - aws ssm get-parameter --name djangoblog_envs_development_postgres --with-decryption --query "Parameter.Value" --output text > .envs/development/postgres
      # -- ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…ã€EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ãªã¨ã“ã‚ã‚’æ›¸ãæ›ãˆã‚‹ --
      - echo "[PreBuild] Fetching EC2 Public IP"
      # èµ·å‹•ã—ã¦ã„ã‚‹EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IDã‚’aws-cliã§å–å¾—
      - |
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=MyAppEc2" \
          --query "Reservations[0].Instances[0].InstanceId" \
          --output text)
        # ãã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        echo "Detected Public IP: $PUBLIC_IP"
        echo "[PreBuild] Patching env files with PUBLIC_IP"
        # æ›¸ãæ›ãˆé–‹å§‹
        sed -i "s|DJANGO_ALLOWED_HOSTS=.*|DJANGO_ALLOWED_HOSTS=$PUBLIC_IP|" .envs/development/django
        sed -i "s|VITE_API_HOST_ADDRESS=.*|VITE_API_HOST_ADDRESS=http://$PUBLIC_IP/api|" .envs/development/frontend
        sed -i "s|VITE_FRONT_HOST_ADDRESS=.*|VITE_FRONT_HOST_ADDRESS=http://$PUBLIC_IP|" .envs/development/frontend

  build:
    commands:
      - echo "[Build] Running Docker Compose build"
      - docker compose -f development.yml build

  post_build:
    commands:
      - echo "[PostBuild] Preparing artifacts for deployment"
      - mkdir -p output
      
      - rsync -av --exclude output ./ output/
      - cp aws_deploy/appspec.yml output/appspec.yml
      - ls -la output
      - echo "[PostBuild] Listing output directory"
      - find output
artifacts:
  files:
    - '**/*'            # ğŸ” output/ (=base-directoryã®å†…å®¹)ä»¥ä¸‹ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã«ã™ã‚‹
  base-directory: output # âœ… output/ ã‚’ãƒ«ãƒ¼ãƒˆã¨ã™ã‚‹
