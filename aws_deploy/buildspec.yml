# CodeBuildãŒä½¿ã†ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã™ã‚‹å†…å®¹
# template.ymlã®Type: AWS::CodeBuild::Projectãªãƒªã‚½ãƒ¼ã‚¹CodeBuildProjectã§ã€Source.BuildSpecã§ã“ã®ymlã‚’æŒ‡å®šã—ã¦ã„ã‚‹
version: 0.2

phases:
  # phasesã¯CodebuildãŒå„ãƒ•ã‚§ãƒ¼ã‚ºã§ãã‚Œãã‚Œå®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ç¤ºã™ã€‚
  # Codebuildã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ãŠã„ã¦ã€å„ãƒ•ã‚§ãƒ¼ã‚ºã¯ã€€https://qiita.com/hiroaki-u/items/b527264093eeb1e406e2#codebuild-1
  # buildpsec.ymlã«è¨˜è¿°ã§ãã‚‹ã®ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«install ,prebuild,build,post_buildã®ã¿
  install:
    commands:
      - echo "[installãƒ•ã‚§ãƒ¼ã‚º]"
      - set -e
      - set -x  # â† è¿½åŠ ï¼šå®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ã™ã¹ã¦å‡ºåŠ›
      - pwd
      # ä»¥ä¸‹ã®å¤‰æ•°ã¯ã€CodeBuildã§æœ€åˆã‹ã‚‰ä½¿ãˆã‚‹ç’°å¢ƒå¤‰æ•°
      # https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-env-ref-env-vars.html
      - echo "CODEBUILD_SRC_DIR=$CODEBUILD_SRC_DIR"
      - ls -la .
      - apt-get update
      - apt-get install -y jq git
      - which git
      - which jq
      - jq --version
  pre_build:
    commands:
      - echo "[pre_buildãƒ•ã‚§ãƒ¼ã‚º] docker-hubãƒ­ã‚°ã‚¤ãƒ³"
      - export DOCKER_USERNAME=$(aws ssm get-parameter --name dockerhub_username --query "Parameter.Value" --output text)
      - export DOCKER_PASSWORD=$(aws ssm get-parameter --name dockerhub_password --with-decryption --query "Parameter.Value" --output text)
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - echo "[pre_buildãƒ•ã‚§ãƒ¼ã‚º] ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã€å€¤ã®å–å¾—ã¨æ›¸æ›"
      # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      - mkdir -p .envs/development
      # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯paramterstoreã‹ã‚‰get-paramterã‚’--with-decryptionã¤ãã§å®Ÿæ–½ -> ãƒ•ã‚¡ã‚¤ãƒ«ã¸å‡ºåŠ›
      - aws ssm get-parameter --name djangoblog_envs_development_frontend --with-decryption --query "Parameter.Value" --output text > .envs/development/frontend

      - aws ssm get-parameter --name djangoblog_envs_development_django --with-decryption --query "Parameter.Value" --output text > .envs/development/django

      - aws ssm get-parameter --name djangoblog_envs_development_postgres --with-decryption --query "Parameter.Value" --output text > .envs/development/postgres
      - echo "[pre_buildãƒ•ã‚§ãƒ¼ã‚º] èµ·å‹•ã—ãŸEC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—ã—ã¦ã€ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆ"
      # -- ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…ã€EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ãªã¨ã“ã‚ã‚’æ›¸ãæ›ãˆã‚‹ --
      # 1ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã€|ã§è¨˜è¿°ã—ã¦ã„ã‚‹
      - |
        # èµ·å‹•ã—ã¦ã„ã‚‹EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IDã‚’aws-cliã§å–å¾—
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=MyAppEc2" \
          --query "Reservations[0].Instances[0].InstanceId" \
          --output text)
        # ãã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’aws-cliã§å–å¾—
        PUBLIC_IP=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query "Reservations[0].Instances[0].PublicIpAddress" \
          --output text)
        echo "Public IP = $PUBLIC_IP"
        echo "[pre_buildãƒ•ã‚§ãƒ¼ã‚º] Patching env files with PUBLIC_IP"
        # æ›¸ãæ›ãˆé–‹å§‹
        sed -i "s|DJANGO_ALLOWED_HOSTS=.*|DJANGO_ALLOWED_HOSTS=$PUBLIC_IP|" .envs/development/django
        sed -i "s|VITE_API_HOST_ADDRESS=.*|VITE_API_HOST_ADDRESS=http://$PUBLIC_IP:8080|" .envs/development/frontend
        sed -i "s|VITE_FRONT_HOST_ADDRESS=.*|VITE_FRONT_HOST_ADDRESS=http://$PUBLIC_IP:8080|" .envs/development/frontend

  build:
    commands:
      - echo "[buildãƒ•ã‚§ãƒ¼ã‚º] ã‚½ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã®å–å¾—ã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ‰€æœ‰è€…ã‚’å¤‰æ›´(root -> 1000)"
      - chown -R 1000:1000 .
      - echo "[buildãƒ•ã‚§ãƒ¼ã‚º] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ“ãƒ«ãƒ‰é–‹å§‹"
      - docker compose -f development.yml run --rm frontend

  post_build:
    commands:
      - echo "[post_buildãƒ•ã‚§ãƒ¼ã‚º] CodeDeployã¸ã¨æ¸¡ã™ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®æº–å‚™"
      - mkdir -p output
      - pwd
      - ls -la .
      - ls -la output
      - echo "[post_buildãƒ•ã‚§ãƒ¼ã‚º] ç¾åœ¨ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼"
      - rsync -av --exclude output ./ output/
      - cp aws_deploy/appspec.yml output/appspec.yml
      - ls -la output
artifacts:
  base-directory: output # CODEBUILD_SRC_DIRç›´ä¸‹ã®output ã‚’ãƒ«ãƒ¼ãƒˆã¨ã™ã‚‹
  files:
    - '**/*'            # ğŸ” output/ (=base-directoryã®å†…å®¹)ä»¥ä¸‹ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã«ã™ã‚‹
  
